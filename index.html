<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Precios (Autoservicio)</title>
    <!-- Carga de Tailwind CSS para un dise帽o moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el cuerpo y la fuente */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .price-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #10B981; /* Verde esmeralda */
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        /* Clase para el mensaje de URL copiada */
        .copied {
            background-color: #ECFDF5;
            color: #059669;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-lg bg-white rounded-xl p-6 sm:p-8 card mt-8">
        <!-- T铆tulo Actualizado -->
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
            Verificador de precios Minimarket Ш
        </h1>
        <p class="text-center text-gray-500 mb-6">
            Ingresa o escanea el c贸digo de barras para verificar precio y stock.
        </p>

        <!-- Mensaje de Carga/Estado de Firebase -->
        <div id="loadingStatus" class="text-center p-2 bg-yellow-100 text-yellow-800 rounded-lg mb-4 text-sm">
            Cargando inventario...
        </div>
        
        <!-- Mensaje de Error de Configuraci贸n de Firebase -->
        <div id="configError" class="text-center p-2 bg-red-100 text-red-800 rounded-lg mb-4 text-sm hidden">
             Error de configuraci贸n. Por favor, revisa la consola para ver los detalles del error.
        </div>


        <!-- Formulario de Entrada -->
        <div class="space-y-4">
            <label for="barcodeInput" class="block text-sm font-medium text-gray-700">
                C贸digo de Barras (Escanea con Lector o Ingresa Manualmente)
            </label>
            <input type="text" id="barcodeInput" placeholder="Ej: 7501035212345"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-lg transition duration-150"
                   onkeydown="if(event.key === 'Enter') checkProduct()">

            <button onclick="checkProduct()"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-[1.01] shadow-md hover:shadow-lg">
                Buscar Producto
            </button>
        </div>
        
        <!-- rea de Resultados -->
        <div id="resultArea" class="mt-8 pt-6 border-t border-gray-200 hidden">
            <h2 id="productName" class="text-2xl font-semibold text-gray-900 mb-4 text-center"></h2>

            <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 rounded-xl mb-4">
                <div class="text-gray-500 text-sm sm:text-base font-medium mb-2 sm:mb-0">Precio de Venta (Sistema):</div>
                <div id="productPrice" class="price-display text-emerald-600"></div>
            </div>

            <div class="flex justify-between items-center bg-gray-50 p-4 rounded-xl">
                <div class="text-gray-500 text-sm sm:text-base font-medium">Stock en Sistema:</div>
                <div id="productStock" class="text-xl font-bold text-blue-600"></div>
            </div>

            <p id="systemMessage" class="text-center text-sm mt-4 text-red-500 hidden"></p>

            <!-- Bot贸n para Agregar si no se encuentra (se muestra din谩micamente) -->
            <button id="addProductBtn" onclick="openAddModal()"
                    class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 rounded-lg transition duration-300 ease-in-out hidden">
                + Cargar Nuevo Producto
            </button>
        </div>

        <!-- Secci贸n de ID de Usuario y Footer -->
        <div class="mt-8 pt-6 border-t border-gray-100">
            <p class="text-sm text-gray-400 text-center mb-2">
                ID de Sesi贸n (para DB): <span id="userIdDisplay" class="font-mono text-xs">Cargando...</span>
            </p>
            <!-- Nuevo Footer Solicitado -->
            <p class="text-xs text-gray-500 text-center font-medium">
                Creado por Minimarket S.A. para uso propio
            </p>
        </div>
    </div>

    <!-- Modal para Agregar/Cargar Producto -->
    <div id="addModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold mb-4">Cargar Nuevo Producto</h3>
            
            <form id="addProductForm" onsubmit="event.preventDefault(); addNewProduct();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">C贸digo de Barras</label>
                        <input type="text" id="modalBarcode" readonly
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                    </div>
                    <div>
                        <label for="modalProductName" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                        <input type="text" id="modalProductName" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="modalProductPrice" class="block text-sm font-medium text-gray-700">Precio de Venta ($)</label>
                        <input type="number" step="0.01" id="modalProductPrice" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="modalProductStock" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" step="1" id="modalProductStock" value="0" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" id="saveProductBtn"
                            class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition">
                        Guardar Producto
                    </button>
                </div>
            </form>
            <p id="modalMessage" class="text-center text-sm mt-3 text-red-500 hidden"></p>
        </div>
    </div>


    <!-- Scripts de Firebase y L贸gica de la Aplicaci贸n -->
    <script type="module">
        // Importaciones de Firebase SDK (requeridas para la DB en tiempo real)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de log para depuraci贸n de Firestore
        setLogLevel('Debug');
        
        // ======================================================================
        // CONFIGURACIN DE FIREBASE (INSERTADA POR EL ASISTENTE)
        // ======================================================================
        const customFirebaseConfig = {
            apiKey: "AIzaSyD2ZIrZvc2crbt7Wqfx6j500yfSyj95870", 
            authDomain: "lector-minimarket.firebaseapp.com",
            projectId: "lector-minimarket", 
            storageBucket: "lector-minimarket.firebasestorage.app", 
            messagingSenderId: "154993425446", 
            appId: "1:154993425446:web:c7dda09846cbd494a3bae7" 
            // measurementId no es necesario para la conexi贸n de DB y Auth
        };
        // ID de la aplicaci贸n. Usamos el projectId de Firebase como identificador principal.
        const appId = customFirebaseConfig.projectId; 
        
        const firebaseConfig = customFirebaseConfig;
        // ----------------------------------------------------------------------
        
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let inventoryData = {}; 

        const loadingStatusEl = document.getElementById('loadingStatus');
        const configErrorEl = document.getElementById('configError');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const barcodeInput = document.getElementById('barcodeInput');
        
        const resultArea = document.getElementById('resultArea');
        const productNameEl = document.getElementById('productName');
        const productPriceEl = document.getElementById('productPrice');
        const productStockEl = document.getElementById('productStock');
        const systemMessageEl = document.getElementById('systemMessage');
        const addProductBtn = document.getElementById('addProductBtn');

        const modal = document.getElementById('addModal');
        const modalBarcodeEl = document.getElementById('modalBarcode');
        const modalProductNameEl = document.getElementById('modalProductName');
        const modalProductPriceEl = document.getElementById('modalProductPrice');
        const modalProductStockEl = document.getElementById('modalProductStock');
        const modalMessageEl = document.getElementById('modalMessage');
        
        /**
         * Inicializa Firebase y la autenticaci贸n.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Inicio de sesi贸n an贸nimo (suficiente para la DB p煤blica 'inventory')
                await signInAnonymously(auth);

                // Esperar el estado de autenticaci贸n
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = userId;
                        loadingStatusEl.textContent = 'Inventario listo.';
                        loadingStatusEl.classList.replace('bg-yellow-100', 'bg-green-100');
                        loadingStatusEl.classList.replace('text-yellow-800', 'text-green-800');

                        // Una vez autenticado, iniciar la escucha de la base de datos
                        listenForInventoryChanges();
                    } else {
                        console.error("No se pudo autenticar al usuario.");
                        userIdDisplayEl.textContent = 'Error de Auth.';
                        loadingStatusEl.textContent = 'Error: No se pudo autenticar.';
                        loadingStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                        loadingStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loadingStatusEl.textContent = `Error: ${error.message}. Verifica las claves.`;
                loadingStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                loadingStatusEl.classList.replace('text-yellow-800', 'text-red-800');
            }
        }

        /**
         * Establece un listener en tiempo real para el inventario.
         */
        function listenForInventoryChanges() {
            // Usaremos la colecci贸n 'inventory'
            const inventoryPath = `inventory`;
            const inventoryRef = collection(db, inventoryPath);

            // onSnapshot mantiene los datos sincronizados en tiempo real
            onSnapshot(inventoryRef, (snapshot) => {
                const newInventory = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Usamos el ID del documento (que es el c贸digo de barras) como clave
                    newInventory[doc.id] = data;
                });
                inventoryData = newInventory;
                console.log("Inventario actualizado en tiempo real.", inventoryData);
            }, (error) => {
                console.error("Error al escuchar cambios en el inventario:", error);
                loadingStatusEl.textContent = 'Error de conexi贸n con la DB.';
                loadingStatusEl.classList.replace('bg-green-100', 'bg-red-100');
                loadingStatusEl.classList.replace('text-green-800', 'text-red-800');
            });
        }

        /**
         * Funci贸n principal para buscar el producto basado en el c贸digo de barras.
         */
        window.checkProduct = function() {
            const barcode = barcodeInput.value.trim();

            // Limpiar resultados anteriores y ocultar el bot贸n de agregar
            resultArea.classList.add('hidden');
            systemMessageEl.classList.add('hidden');
            addProductBtn.classList.add('hidden');

            // Vaciar el input inmediatamente para prepararlo para el siguiente escaneo
            barcodeInput.value = ''; 
            barcodeInput.focus();

            if (!barcode) {
                systemMessageEl.textContent = "Por favor, ingresa un c贸digo de barras.";
                systemMessageEl.classList.remove('hidden');
                return;
            }
            
            // Buscar en el inventario cargado de Firestore
            const product = inventoryData[barcode];

            if (product) {
                // Producto encontrado
                productNameEl.textContent = product.name || 'Sin Nombre';
                
                // Formatear el precio a moneda
                const price = product.price || 0;
                productPriceEl.textContent = `$${parseFloat(price).toFixed(2).replace('.', ',')}`;
                
                // Mostrar el stock
                const stock = product.stock || 0;
                productStockEl.textContent = stock;

                resultArea.classList.remove('hidden');

                // Mensaje de verificaci贸n (Stock)
                systemMessageEl.classList.remove('text-orange-500', 'text-red-500');
                if (stock > 0 && stock <= 20) {
                    systemMessageEl.textContent = "隆ATENCIN! El stock es bajo.";
                    systemMessageEl.classList.remove('hidden');
                    systemMessageEl.classList.add('text-orange-500');
                } else if (stock === 0) {
                    systemMessageEl.textContent = "隆AGOTADO! Verificar exhibici贸n en g贸ndola.";
                    systemMessageEl.classList.remove('hidden');
                    systemMessageEl.classList.add('text-red-500');
                } else {
                    systemMessageEl.classList.add('hidden');
                }


            } else {
                // Producto no encontrado
                productNameEl.textContent = "Producto No Encontrado";
                productPriceEl.textContent = "---";
                productStockEl.textContent = "0";

                systemMessageEl.textContent = `El c贸digo "${barcode}" no est谩 registrado en el sistema. Debe ser cargado.`;
                systemMessageEl.classList.remove('hidden');
                systemMessageEl.classList.remove('text-orange-500');
                systemMessageEl.classList.add('text-red-500');

                addProductBtn.classList.remove('hidden'); // Mostrar el bot贸n para a帽adir
                resultArea.classList.remove('hidden');
            }
        }
        
        // --- L贸gica del Modal (A帽adir Producto) ---

        window.openAddModal = function() {
            const barcode = barcodeInput.value.trim() || addProductBtn.dataset.barcode;
            if (!barcode) return;
            
            // Prellenar el campo de c贸digo de barras
            modalBarcodeEl.value = barcode;

            // Limpiar campos de entrada y mensajes
            modalProductNameEl.value = '';
            modalProductPriceEl.value = '';
            modalProductStockEl.value = 0;
            modalMessageEl.classList.add('hidden');

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.scale-95').classList.remove('scale-95');
            modal.querySelector('.scale-95').classList.add('scale-100');

            setTimeout(() => modalProductNameEl.focus(), 300);
        }

        window.closeAddModal = function() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.scale-100').classList.remove('scale-100');
            modal.querySelector('.scale-100').classList.add('scale-95');
            addProductBtn.classList.add('hidden'); // Ocultar despu茅s de cerrar
            barcodeInput.focus();
        }

        /**
         * Agrega un nuevo producto a Firestore.
         */
        window.addNewProduct = async function() {
            const barcode = modalBarcodeEl.value.trim();
            const name = modalProductNameEl.value.trim();
            const price = parseFloat(modalProductPriceEl.value);
            const stock = parseInt(modalProductStockEl.value, 10);
            
            modalMessageEl.classList.add('hidden');

            if (!barcode || !name || isNaN(price) || isNaN(stock)) {
                modalMessageEl.textContent = "Por favor, completa todos los campos correctamente.";
                modalMessageEl.classList.remove('hidden');
                return;
            }

            try {
                // La ruta de la colecci贸n p煤blica y el ID del documento es el c贸digo de barras
                // Usamos la colecci贸n 'inventory'
                const docRef = doc(db, `inventory`, barcode);

                await setDoc(docRef, {
                    name: name,
                    price: price,
                    stock: stock,
                    lastUpdated: new Date().toISOString(),
                    updaterId: userId
                });

                modalMessageEl.textContent = `"${name}" cargado exitosamente.`;
                modalMessageEl.classList.remove('hidden', 'text-red-500');
                modalMessageEl.classList.add('text-green-600');
                
                // Cerrar el modal despu茅s de un breve tiempo
                setTimeout(() => {
                    closeAddModal();
                    // Forzar la actualizaci贸n del producto reci茅n cargado en la UI principal
                    barcodeInput.value = barcode; 
                    checkProduct();
                }, 1500);


            } catch (e) {
                console.error("Error al a帽adir documento: ", e);
                modalMessageEl.textContent = `Error al guardar: ${e.message}`;
                modalMessageEl.classList.remove('hidden');
            }
        }
        
        // Enfocar el input al cargar la p谩gina para facilitar el "escaneo"
        window.onload = () => {
            initializeFirebase();
            barcodeInput.focus();
        };

    </script>
</body>
</html>
